import{_ as s,o as n,c as a,O as l}from"./chunks/framework.72ba6402.js";const d=JSON.parse('{"title":"初识k8s和动手实践","description":"","frontmatter":{"title":"初识k8s和动手实践","comment":true,"tags":["k8s","Docker"],"categories":["学习小册"],"sticky":1},"headers":[],"relativePath":"booklet/k8s/初识k8s和动手实践.md","filePath":"booklet/k8s/初识k8s和动手实践.md","lastUpdated":1686303785000}'),p={name:"booklet/k8s/初识k8s和动手实践.md"},o=l(`<h2 id="什么是kubernetes" tabindex="-1">什么是Kubernetes <a class="header-anchor" href="#什么是kubernetes" aria-label="Permalink to &quot;什么是Kubernetes&quot;">​</a></h2><p>Kubernetes 是一个可扩展的，用于容器化应用程序编排，管理的平台。Kubernetes 建立在 <a href="https://research.google/pubs/pub43438" target="_blank" rel="noreferrer">Google 大规模运行生产工作负载十几年经验</a>的基础上， 结合了社区中最优秀的想法和实践。由Google于2014年开源出来，目前在国内外大大小小的公司都得到了广泛的应用。</p><p><strong>Kubernetes</strong> 这个名字源于希腊语，意为“舵手”或“飞行员”。k8s 这个缩写是因为 k 和 s 之间有八个字符的关系。后面都用简称k8s。</p><p>k8s 可支持公有云，私有云及混合云等，具备良好的可移植性。我们可直接使用它或在其之上构建自己的容器/云平台，以达到快速部署，快速扩展，及优化资源使用等。它致力于提供通用接口类似 CNI( Container Network Interface ), CSI(Container Storage Interface), CRI(Container Runtime Interface)等规范，以便有更多可能, 让更多的厂商共同加入其生态 体系内。</p><h2 id="为什么需要k8s" tabindex="-1">为什么需要k8s <a class="header-anchor" href="#为什么需要k8s" aria-label="Permalink to &quot;为什么需要k8s&quot;">​</a></h2><p>不论是前端，后端，或者运维人员，可能都遇到过node安装版本不一致，服务器和本地环境不一致，频繁部署环境中间出现各种安装不了等问题。对于这些问题，目前来看最好的解决办法是标准化，容器化。目前用的最多的是Docker，通过Dockerfile对环境进行描述，对镜像进行交付，使用时不再关注环境不一致的问题。</p><p>作为一个技术人员，我们应该对整体的体系架构有所了解, 掌握更多 的技能，了解软件的完整生命周期，包括开发，交付，部署，以及当 流量变大时的扩容等。</p><p>在容器编排领域目前用的比较多的是k8s，docker-compose，swarm等。</p><h2 id="基础概念" tabindex="-1">基础概念 <a class="header-anchor" href="#基础概念" aria-label="Permalink to &quot;基础概念&quot;">​</a></h2><h3 id="node" tabindex="-1">Node <a class="header-anchor" href="#node" aria-label="Permalink to &quot;Node&quot;">​</a></h3><p>我们项目中跑服务的物理机或者虚拟机，对k8s来说这台服务器就是k8s中的Node。</p><ul><li><p>Node状态</p><p>拿到服务器之后，我们一般会查看一下服务器的基本配置和信息，对加入k8s中的Node也是一样的，需要先检查它的状态，并上报到集群。</p></li><li><p>地址</p><p>内部ip在集群内访问，外部ip在集群外访问，在k8s中每个Node的主机名会被记录下来。类似主机中用hostname命令获取的主机名。</p></li><li><p>信息</p><p>类似在主机中cat /etc/issue、cat /etc/os-release等方法查看的信息，k8s也会把Node的基础信息记录下来。</p></li><li><p>容量</p><p>统计CPU、内存等信息，以便于计算Node中可用Pod数量。</p></li><li><p>条件</p><p>如果上述信息都满足我们需求，在集群内该Node被标记为Ready，这样我们的服务器就完成了交付。</p></li></ul><h3 id="deployment和pod" tabindex="-1">Deployment和Pod <a class="header-anchor" href="#deployment和pod" aria-label="Permalink to &quot;Deployment和Pod&quot;">​</a></h3><p>假设我们现在需要用Nginx对一个静态html提供访问，对k8s来说，能提供html的访问服务就是deployment，对Nginx和html的组合可以理解为Pod，作为最小的调度单元。</p><h3 id="container-runtime" tabindex="-1">Container Runtime <a class="header-anchor" href="#container-runtime" aria-label="Permalink to &quot;Container Runtime&quot;">​</a></h3><p>虽然目前只提供了一个静态网页的访问，但是为了避免故障，我们再申请2个服务器，对原来的服务进行扩容，增加一台服务器我们做的是完全重复的事情，我们可选方案有kvm，Docker等技术，对于k8s来说，Docker就是container Runtime。</p><h2 id="本地搭建k8s集群" tabindex="-1">本地搭建k8s集群 <a class="header-anchor" href="#本地搭建k8s集群" aria-label="Permalink to &quot;本地搭建k8s集群&quot;">​</a></h2><h3 id="方案选择" tabindex="-1">方案选择 <a class="header-anchor" href="#方案选择" aria-label="Permalink to &quot;方案选择&quot;">​</a></h3><ul><li><a href="https://github.com/kubernetes-sigs/kind" target="_blank" rel="noreferrer">kind</a>(Kubernetes in Docker)</li><li>minikube(是 K8S 官方为了开发者能在个人电脑上运行 K8S 而提供 的一套工具。实现上是通过 Go 语言编写，通过调用虚拟化管理程 序，创建出一个运行在虚拟机内的单节点集群。)</li><li>Docker desktop</li><li>Kubeadm(官方推荐用于生产环境)</li></ul><h3 id="创建集群" tabindex="-1">创建集群 <a class="header-anchor" href="#创建集群" aria-label="Permalink to &quot;创建集群&quot;">​</a></h3><p>为了方便，我们选择Docker desktop默认的k8s创建方案。首先需要安装好Docker环境，不再赘述。</p><p>安装好kubectl，方便对搭建好的集群进行管理。kubectl 版本和集群之间的差异必须在一个小版本号之内。 例如：v1.27 版本的客户端能与 v1.26、 v1.27 和 v1.28 版本的控制面通信。 用最新兼容版本的 kubectl 有助于避免不可预见的问题。</p><p><img src="https://cdn.jsdelivr.net/gh/lpdswing/oss@main/202306061724997.png" alt=""></p><p>验证集群是否正常启动，出现以下信息表示正常启动。</p><p><img src="https://cdn.jsdelivr.net/gh/lpdswing/oss@main/202306061737059.png" alt=""></p><h2 id="搭建一个生成环境可以的集群" tabindex="-1">搭建一个生成环境可以的集群 <a class="header-anchor" href="#搭建一个生成环境可以的集群" aria-label="Permalink to &quot;搭建一个生成环境可以的集群&quot;">​</a></h2><p>大多数人的需求并不只是包含一个虚拟机节点的本地测试集群，而是 一个可在服务器运行，可自行扩/缩容，具备全部功能的，达到生产 可用的集群。我们选择一个 Kubernetes 官方推荐的方案 kubeadm 进行搭建。</p><p>kubeadm 是 Kubernetes 官方提供的一个 CLI 工具，可以很方便的 搭建一套符合官方最佳实践的最小化可用集群。</p><p>安装kubeadm(<a href="https://kubernetes.io/zh-cn/docs/setup/production-environment/tools/kubeadm/install-kubeadm/" target="_blank" rel="noreferrer">安装 kubeadm | Kubernetes</a>)</p><p>支持的Docker的最新版本为20.10.17。</p><p>当前使用k8s最新版本为1.27.2。</p><h3 id="准备" tabindex="-1">准备 <a class="header-anchor" href="#准备" aria-label="Permalink to &quot;准备&quot;">​</a></h3><ul><li><p>禁用swap</p><ul><li><p>通过<code>sudo swapoff -a</code>临时关闭swap</p></li><li><div class="language-swift"><button title="Copy Code" class="copy"></button><span class="lang">swift</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#A6ACCD;">sudo vim </span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">etc</span><span style="color:#89DDFF;">/</span><span style="color:#A6ACCD;">fstab     注释swap相关</span></span></code></pre></div></li></ul></li><li><p><code>sudo cat /sys/class/dmi/id/product_uuid</code>可查看机器的 product_uuid 请确保要搭建集群的所有节点的 product_uuid 均不相同。</p></li><li><p><code>sudo ufw disable </code>禁用防火墙。</p></li><li><p>配置主机hosts。</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># sudo vim /etc/hosts</span></span>
<span class="line"><span style="color:#FFCB6B;">10.211.55.3</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">k8s-master</span></span></code></pre></div></li><li><p>安装Docker</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">update</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt-transport-https</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ca-certificates</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">curl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">gnupg-agent</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">software-properties-common</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 导入源仓库的 GPG key</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">curl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-fsSL</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://download.docker.com/linux/ubuntu/gpg</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt-key</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">add</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 添加Docker软件源</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">add-apt-repository</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">deb [arch=amd64] https://download.docker.com/linux/ubuntu </span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">lsb_release</span><span style="color:#C3E88D;"> -cs</span><span style="color:#89DDFF;">)</span><span style="color:#C3E88D;"> stable</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">update</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 查看所有可用Docker版本</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">list</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker-ce</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">install</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker-ce=</span><span style="color:#F78C6C;">5</span><span style="color:#C3E88D;">:20.10.17~3-0~ubuntu-jammy</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker-ce-cli=</span><span style="color:#F78C6C;">5</span><span style="color:#C3E88D;">:20.10.17~3-0~ubuntu-jammy</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">containerd.io</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">systemctl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">status</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 锁定版本</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apt-mark</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">hold</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker-ce</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">vi</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/docker/daemon.json</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#676E95;font-style:italic;"># 输入下面json</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">{</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">&quot;registry-mirrors&quot;</span><span style="color:#82AAFF;">:</span><span style="color:#A6ACCD;"> [</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">&quot;https://dockerhub.azk8s.cn&quot;</span><span style="color:#FFCB6B;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">&quot;https://reg-mirror.qiniu.com&quot;</span><span style="color:#FFCB6B;">,</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">&quot;https://quay-mirror.qiniu.com&quot;</span></span>
<span class="line"><span style="color:#A6ACCD;">  ],</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">&quot;exec-opts&quot;</span><span style="color:#82AAFF;">:</span><span style="color:#A6ACCD;"> [ </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">native.cgroupdriver=systemd</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">]</span><span style="color:#A6ACCD;"> </span></span>
<span class="line"><span style="color:#89DDFF;">}</span></span>
<span class="line"><span style="color:#FFCB6B;">systemctl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">daemon-reload</span></span>
<span class="line"><span style="color:#FFCB6B;">systemctl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">restart</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#查看修改后的 docker cgroup 状态</span></span>
<span class="line"><span style="color:#FFCB6B;">docker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">info</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">grep</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">Cgroup</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 当前用户加入Docker组</span></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">usermod</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-aG</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docker</span><span style="color:#A6ACCD;"> $USER</span></span></code></pre></div></li><li><p>安装kubeadm，kubectl，kubelet，安装步骤参考上面链接。<code>apt-cache madison kubeadm|head</code>查看版本</p></li><li><p><code>sudo netstat -ntlp |grep -E &#39;6443|23[79,80]|1025[0,1,2]&#39; </code>检查是否有端口占用，如果有就手动释放。</p></li></ul><h3 id="配置" tabindex="-1">配置 <a class="header-anchor" href="#配置" aria-label="Permalink to &quot;配置&quot;">​</a></h3><p>为了保证生产环境的稳定运行，我们增加kubelet的systemd配置，对服务进行管理。</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">cat</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;&lt;</span><span style="color:#89DDFF;">EOF</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> /etc/systemd/system/kubelet.service</span></span>
<span class="line"><span style="color:#C3E88D;">[Unit]</span></span>
<span class="line"><span style="color:#C3E88D;">Description=kubelet: The Kubernetes Node Agent</span></span>
<span class="line"><span style="color:#C3E88D;">Documentation=https://kubernetes.io/docs/home/</span></span>
<span class="line"><span style="color:#C3E88D;">Wants=network-online.target</span></span>
<span class="line"><span style="color:#C3E88D;">After=network-online.target</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C3E88D;">[Service]</span></span>
<span class="line"><span style="color:#C3E88D;">ExecStart=/usr/bin/kubelet</span></span>
<span class="line"><span style="color:#C3E88D;">Restart=always</span></span>
<span class="line"><span style="color:#C3E88D;">StartLimitInterval=0</span></span>
<span class="line"><span style="color:#C3E88D;">RestartSec=10</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C3E88D;">[Install]</span></span>
<span class="line"><span style="color:#C3E88D;">WantedBy=multi-user.target</span></span>
<span class="line"><span style="color:#89DDFF;">EOF</span></span></code></pre></div><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">mkdir</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-p</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/systemd/system/kubelet.service.d</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 设置kubelet开机自启</span></span>
<span class="line"><span style="color:#FFCB6B;">systemctl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">enable</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubelet</span></span></code></pre></div><p>配置containerd，常见的CRI有：containerd、CRI-O、Docker Engine、Mirantis Container Runtime。containerd需要和kubelet使用一样的systemd。</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">containerd</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">default</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/containerd/config.toml</span></span>
<span class="line"><span style="color:#FFCB6B;">vim</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/containerd/config.toml</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">SystemdCgroup</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">false</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">改为</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">SystemdCgroup</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">=</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">true</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;">#重新加载并重启containerd</span></span>
<span class="line"><span style="color:#FFCB6B;">systemctl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">daemon-reload</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&amp;&amp;</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">systemctl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">restart</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">containerd</span></span></code></pre></div><h3 id="启动" tabindex="-1">启动 <a class="header-anchor" href="#启动" aria-label="Permalink to &quot;启动&quot;">​</a></h3><ul><li><p>安装crictl(目前apt安装已经带了，不需要手动安装了)</p><ul><li><code>crictl</code> 是 <code>kubelet</code> CRI (Container Runtime Interface) 的 CLI</li><li><code>critest</code> 是 <code>kubelet</code> CRI 的测试工具集。</li></ul><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># install crictl</span></span>
<span class="line"><span style="color:#A6ACCD;">VERSION</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">v1.26.0</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#FFCB6B;">wget</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/kubernetes-sigs/cri-tools/releases/download/</span><span style="color:#A6ACCD;">$VERSION</span><span style="color:#C3E88D;">/crictl-</span><span style="color:#A6ACCD;">$VERSION</span><span style="color:#C3E88D;">-linux-amd64.tar.gz</span></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">tar</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">zxvf</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">crictl-</span><span style="color:#A6ACCD;">$VERSION</span><span style="color:#C3E88D;">-linux-amd64.tar.gz</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-C</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/usr/local/bin</span></span>
<span class="line"><span style="color:#FFCB6B;">rm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-f</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">crictl-</span><span style="color:#A6ACCD;">$VERSION</span><span style="color:#C3E88D;">-linux-amd64.tar.gz</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># install critest</span></span>
<span class="line"><span style="color:#A6ACCD;">VERSION</span><span style="color:#89DDFF;">=</span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">v1.26.0</span><span style="color:#89DDFF;">&quot;</span></span>
<span class="line"><span style="color:#FFCB6B;">wget</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/kubernetes-sigs/cri-tools/releases/download/</span><span style="color:#A6ACCD;">$VERSION</span><span style="color:#C3E88D;">/critest-</span><span style="color:#A6ACCD;">$VERSION</span><span style="color:#C3E88D;">-linux-amd64.tar.gz</span></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">tar</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">zxvf</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">critest-</span><span style="color:#A6ACCD;">$VERSION</span><span style="color:#C3E88D;">-linux-amd64.tar.gz</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-C</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/usr/local/bin</span></span>
<span class="line"><span style="color:#FFCB6B;">rm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-f</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">critest-</span><span style="color:#A6ACCD;">$VERSION</span><span style="color:#C3E88D;">-linux-amd64.tar.gz</span></span></code></pre></div></li><li><p>安装socat</p><ul><li><code>socat</code> 是一款很强大的命令行工具，可以建立两个双向字节流并在其中传输数据。它其中的一个功能是可以实现端口转发。</li><li>ubuntu下使用<code>sudo apt-get install -y socat</code>进行安装。</li></ul></li><li><p>初始化集群</p><div class="language-bash"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">kubeadm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">config</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">print</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">init-defaults</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubeadm.yaml</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 配置文件如下</span></span>
<span class="line"><span style="color:#FFCB6B;">apiVersion:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubeadm.k8s.io/v1beta3</span></span>
<span class="line"><span style="color:#FFCB6B;">bootstrapTokens:</span></span>
<span class="line"><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">groups:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">system:bootstrappers:kubeadm:default-node-token</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">token:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">abcdef.0123456789abcdef</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">ttl:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">24</span><span style="color:#C3E88D;">h0m0s</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">usages:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">signing</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">-</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">authentication</span></span>
<span class="line"><span style="color:#FFCB6B;">kind:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">InitConfiguration</span></span>
<span class="line"><span style="color:#FFCB6B;">localAPIEndpoint:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">advertiseAddress:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10.211</span><span style="color:#C3E88D;">.55.3</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">bindPort:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">6443</span></span>
<span class="line"><span style="color:#FFCB6B;">nodeRegistration:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">criSocket:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">unix:///var/run/containerd/containerd.sock</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">imagePullPolicy:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">IfNotPresent</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">name:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">k8s-master</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">taints:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">null</span></span>
<span class="line"><span style="color:#FFCB6B;">---</span></span>
<span class="line"><span style="color:#FFCB6B;">apiServer:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">timeoutForControlPlane:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">4</span><span style="color:#C3E88D;">m0s</span></span>
<span class="line"><span style="color:#FFCB6B;">apiVersion:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubeadm.k8s.io/v1beta3</span></span>
<span class="line"><span style="color:#FFCB6B;">certificatesDir:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/kubernetes/pki</span></span>
<span class="line"><span style="color:#FFCB6B;">clusterName:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubernetes</span></span>
<span class="line"><span style="color:#FFCB6B;">controllerManager:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{}</span></span>
<span class="line"><span style="color:#FFCB6B;">dns:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{}</span></span>
<span class="line"><span style="color:#FFCB6B;">etcd:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">local:</span></span>
<span class="line"><span style="color:#A6ACCD;">    </span><span style="color:#FFCB6B;">dataDir:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/var/lib/etcd</span></span>
<span class="line"><span style="color:#FFCB6B;">imageRepository:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">registry.k8s.io</span></span>
<span class="line"><span style="color:#FFCB6B;">kind:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">ClusterConfiguration</span></span>
<span class="line"><span style="color:#FFCB6B;">kubernetesVersion:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">1.27</span><span style="color:#C3E88D;">.2</span></span>
<span class="line"><span style="color:#FFCB6B;">networking:</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">dnsDomain:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">cluster.local</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">serviceSubnet:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10.96</span><span style="color:#C3E88D;">.0.0/12</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">podSubnet:</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10.1</span><span style="color:#C3E88D;">.0.0/16</span><span style="color:#A6ACCD;">  </span><span style="color:#676E95;font-style:italic;"># 增加指定pod的网段</span></span>
<span class="line"><span style="color:#FFCB6B;">scheduler:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">{}</span></span>
<span class="line"><span style="color:#FFCB6B;">---</span></span>
<span class="line"><span style="color:#676E95;font-style:italic;"># 指定cgroup</span></span>
<span class="line"><span style="color:#FFCB6B;">apiVersion:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubelet.config.k8s.io/v1beta1</span></span>
<span class="line"><span style="color:#FFCB6B;">kind:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">KubeletConfiguration</span></span>
<span class="line"><span style="color:#FFCB6B;">cgroupDriver:</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">systemd</span></span></code></pre></div><p>![image-20230609145745282](/Users/lpdswing/Library/Application Support/typora-user-images/image-20230609145745282.png)</p></li></ul><p>​ <code>kubeadm init</code> 执行起见生成了一些文件，而这些文件我们先前在 kubelet server 的 <code>Drop-in</code> 的配置中配置过。</p><p>​ 生成这些配置文件后，将启动 <code>kubelet</code> 服务，生成一系列的证书和相关的配置之类的，并增加一些扩展。</p><p>​ 最终集群创建成功，并提示可在任意机器上使用指定命令加入集群。</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">To</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">start</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">using</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">your</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">cluster,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">you</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">need</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">to</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">run</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">the</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">following</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">regular</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">user:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">mkdir</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-p</span><span style="color:#A6ACCD;"> $HOME</span><span style="color:#C3E88D;">/.kube</span></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">cp</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-i</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/kubernetes/admin.conf</span><span style="color:#A6ACCD;"> $HOME</span><span style="color:#C3E88D;">/.kube/config</span></span>
<span class="line"><span style="color:#FFCB6B;">sudo</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">chown</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">id</span><span style="color:#C3E88D;"> -u</span><span style="color:#89DDFF;">)</span><span style="color:#C3E88D;">:</span><span style="color:#89DDFF;">$(</span><span style="color:#FFCB6B;">id</span><span style="color:#C3E88D;"> -g</span><span style="color:#89DDFF;">)</span><span style="color:#A6ACCD;"> $HOME</span><span style="color:#C3E88D;">/.kube/config</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">Alternatively,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">if</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">you</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">are</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">the</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">root</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">user,</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">you</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">can</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">run:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#C792EA;">export</span><span style="color:#A6ACCD;"> KUBECONFIG</span><span style="color:#89DDFF;">=</span><span style="color:#C3E88D;">/etc/kubernetes/admin.conf</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">You</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">should</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">now</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">deploy</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">a</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pod</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">network</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">to</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">the</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">cluster.</span></span>
<span class="line"><span style="color:#FFCB6B;">Run</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&quot;</span><span style="color:#C3E88D;">kubectl apply -f [podnetwork].yaml</span><span style="color:#89DDFF;">&quot;</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">with</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">one</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">of</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">the</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">options</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">listed</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">at:</span></span>
<span class="line"><span style="color:#FFCB6B;">https://kubernetes.io/docs/concepts/cluster-administration/addons/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">Then</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">you</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">can</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">join</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">any</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">number</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">of</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">worker</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nodes</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">by</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">running</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">the</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">following</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">on</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">each</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">as</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">root:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">kubeadm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">join</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10.211</span><span style="color:#C3E88D;">.55.3:6443</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--token</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">abcdef.0123456789abcdef</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#C3E88D;">--discovery-token-ca-cert-hash</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sha256:af686c123ef26692b818eda43838997ba0997d76ac2fd509ab643a838e78201d</span></span></code></pre></div><ul><li><p>验证</p><p>![image-20230609150039514](/Users/lpdswing/Library/Application Support/typora-user-images/image-20230609150039514.png)</p></li></ul><p>​ K8S 默认会监听一些端口，但并不是 <code>8080</code> 端口，由此可知，我们的 <code>kubectl</code>配置有误。</p><ul><li><p>配置kubectl</p><ul><li>使用 <code>kubectl</code> 的参数 <code>--kubeconfig</code> 或者环境变量 <code>KUBECONFIG</code></li></ul><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">root@k8s-master:/home/tom#</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--kubeconfig</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/etc/kubernetes/admin.conf</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">get</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nodes</span></span>
<span class="line"><span style="color:#FFCB6B;">NAME</span><span style="color:#A6ACCD;">         </span><span style="color:#C3E88D;">STATUS</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">ROLES</span><span style="color:#A6ACCD;">           </span><span style="color:#C3E88D;">AGE</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">VERSION</span></span>
<span class="line"><span style="color:#FFCB6B;">k8s-master</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">NotReady</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">control-plane</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">6</span><span style="color:#C3E88D;">m10s</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">v1.27.2</span></span>
<span class="line"><span style="color:#FFCB6B;">root@k8s-master:/home/tom#</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">KUBECONFIG=/etc/kubernetes/admin.conf</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">get</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">nodes</span></span>
<span class="line"><span style="color:#FFCB6B;">NAME</span><span style="color:#A6ACCD;">         </span><span style="color:#C3E88D;">STATUS</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">ROLES</span><span style="color:#A6ACCD;">           </span><span style="color:#C3E88D;">AGE</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">VERSION</span></span>
<span class="line"><span style="color:#FFCB6B;">k8s-master</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">NotReady</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">control-plane</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">6</span><span style="color:#C3E88D;">m44s</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">v1.27.2</span></span>
<span class="line"><span style="color:#FFCB6B;">root@k8s-master:/home/tom#</span></span></code></pre></div><ul><li>更改默认配置文件</li></ul><p><img src="https://cdn.jsdelivr.net/gh/lpdswing/oss@main/202306091505052.png" alt=""></p></li><li><p>配置集群网络</p><p>通过上面的配置，我们已经可以正常获取 <code>Node</code> 信息。但是状态是notready,可以通过<code>kubectl get nodes -o yaml</code>查看详细信息。</p><p><img src="https://cdn.jsdelivr.net/gh/lpdswing/oss@main/202306091510150.png" alt=""></p></li></ul><p>​ <code>CNI</code> 是 Container Network Interface 的缩写，是 K8S 用于配置 Linux 容器网络的接口规范。</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># 使用flannel 当前最新</span></span>
<span class="line"><span style="color:#FFCB6B;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">apply</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-f</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">https://github.com/flannel-io/flannel/releases/latest/download/kube-flannel.yml</span></span></code></pre></div><p>![image-20230609152153990](/Users/lpdswing/Library/Application Support/typora-user-images/image-20230609152153990.png)</p><p>查看一下现有集群Pod状态。</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">kubectl</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">get</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pods</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--all-namespaces</span></span>
<span class="line"><span style="color:#FFCB6B;">NAMESPACE</span><span style="color:#A6ACCD;">      </span><span style="color:#C3E88D;">NAME</span><span style="color:#A6ACCD;">                                 </span><span style="color:#C3E88D;">READY</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">STATUS</span><span style="color:#A6ACCD;">              </span><span style="color:#C3E88D;">RESTARTS</span><span style="color:#A6ACCD;">      </span><span style="color:#C3E88D;">AGE</span></span>
<span class="line"><span style="color:#FFCB6B;">kube-flannel</span><span style="color:#A6ACCD;">   </span><span style="color:#C3E88D;">kube-flannel-ds-gqmtk</span><span style="color:#A6ACCD;">                </span><span style="color:#F78C6C;">0</span><span style="color:#C3E88D;">/1</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">Error</span><span style="color:#A6ACCD;">               </span><span style="color:#F78C6C;">3</span><span style="color:#A6ACCD;"> (33s </span><span style="color:#C3E88D;">ago</span><span style="color:#A6ACCD;">)   74s</span></span>
<span class="line"><span style="color:#FFCB6B;">kube-system</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">coredns-5d78c9869d-n89l7</span><span style="color:#A6ACCD;">             </span><span style="color:#F78C6C;">0</span><span style="color:#C3E88D;">/1</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">ContainerCreating</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">             </span><span style="color:#F78C6C;">25</span><span style="color:#C3E88D;">m</span></span>
<span class="line"><span style="color:#FFCB6B;">kube-system</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">coredns-5d78c9869d-wx5q9</span><span style="color:#A6ACCD;">             </span><span style="color:#F78C6C;">0</span><span style="color:#C3E88D;">/1</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">ContainerCreating</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">             </span><span style="color:#F78C6C;">25</span><span style="color:#C3E88D;">m</span></span>
<span class="line"><span style="color:#FFCB6B;">kube-system</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">etcd-k8s-master</span><span style="color:#A6ACCD;">                      </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">/1</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">Running</span><span style="color:#A6ACCD;">             </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">             </span><span style="color:#F78C6C;">26</span><span style="color:#C3E88D;">m</span></span>
<span class="line"><span style="color:#FFCB6B;">kube-system</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">kube-apiserver-k8s-master</span><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">/1</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">Running</span><span style="color:#A6ACCD;">             </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">             </span><span style="color:#F78C6C;">26</span><span style="color:#C3E88D;">m</span></span>
<span class="line"><span style="color:#FFCB6B;">kube-system</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">kube-controller-manager-k8s-master</span><span style="color:#A6ACCD;">   </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">/1</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">Running</span><span style="color:#A6ACCD;">             </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">             </span><span style="color:#F78C6C;">26</span><span style="color:#C3E88D;">m</span></span>
<span class="line"><span style="color:#FFCB6B;">kube-system</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">kube-proxy-srz8c</span><span style="color:#A6ACCD;">                     </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">/1</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">Running</span><span style="color:#A6ACCD;">             </span><span style="color:#F78C6C;">0</span><span style="color:#A6ACCD;">             </span><span style="color:#F78C6C;">25</span><span style="color:#C3E88D;">m</span></span>
<span class="line"><span style="color:#FFCB6B;">kube-system</span><span style="color:#A6ACCD;">    </span><span style="color:#C3E88D;">kube-scheduler-k8s-master</span><span style="color:#A6ACCD;">            </span><span style="color:#F78C6C;">1</span><span style="color:#C3E88D;">/1</span><span style="color:#A6ACCD;">     </span><span style="color:#C3E88D;">Running</span><span style="color:#A6ACCD;">             </span><span style="color:#F78C6C;">1</span><span style="color:#A6ACCD;">             </span><span style="color:#F78C6C;">26</span><span style="color:#C3E88D;">m</span></span></code></pre></div><p>发现有两个 <code>coredns</code> 的 <code>Pod</code> 是 <code>ContainerCreating</code> 的状态，但并未就绪。<code>Pod</code> 实际会有一个调度过程，此处我们暂且不论，后续再对此进行解释。</p><ul><li><p>新增Node</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#676E95;font-style:italic;"># node节点忽略init配置文件修改和网络配置</span></span>
<span class="line"><span style="color:#FFCB6B;">kubeadm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">join</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">10.211</span><span style="color:#C3E88D;">.55.3:6443</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--token</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">abcdef.0123456789abcdef</span><span style="color:#A6ACCD;"> \\</span></span>
<span class="line"><span style="color:#A6ACCD;">	</span><span style="color:#C3E88D;">--discovery-token-ca-cert-hash</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">sha256:af686c123ef26692b818eda43838997ba0997d76ac2fd509ab643a838e78201d</span></span></code></pre></div><p><img src="https://cdn.jsdelivr.net/gh/lpdswing/oss@main/202306091645324.png" alt=""></p></li></ul>`,55),e=[o];function t(c,r,C,y,D,A){return n(),a("div",null,e)}const u=s(p,[["render",t]]);export{d as __pageData,u as default};
